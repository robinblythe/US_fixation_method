---
title: Economic analysis of femoral stem fixation method in a US Medicare population
  with hip fracture
output:
  html_document:
    df_print: paged
---
The goal of this analysis is to replicate the results from Blythe et al (2020): Fixation method for hip stems following femoral neck fracture, but in a US-based Medicare population. The three age groups will be similar to the original study but bounded by Medicare inclusion: 65-74, 75-84, and 85+. Data will be comprised of US-based registry data for transition probabilities (revision, mortality) and costs where possible. Where new data is unobtainable, we will use values from the literature. The analysis is shown below.

```{r, message = FALSE}
options(scipen = 100, digits = 5)
library(EnvStats)
library(patchwork)
library(gridExtra)
library(knitr)
library(tidyverse)
```

The basic structure of this population-based model is as follows:  
1. Obtain the basic prevalence of each group: HA vs THA, cemented vs cementless, and by age, for 12 groups in total. All patients in this model are assumed to be receiving their new hips following a femoral neck fracture.  
2. Assume that each group enters the model at time 0, or when they first receive the prosthesis, and are assigned a cost for the procedure.  
3. Each group then proceeds through a 5 year span, iterating by year, with the costs and utilities of stable states, revisions and dislocations varying by year. The stable population in each year corresponds to the surviving population who has not undergone a revision surgery or closed reduction of dislocation.  
4. The differences between the baseline population and a default strategy of cementing or not cementing for each age group will be calculated by assuming that all patients receive a particular fixation type for femoral stem, rather than using the existing prevalence of each procedure.  

```{r}
# Call parameters and functions required to populate models
set.seed(888) # repeatability
source("./0_Parameters_US.R")
source("./1_Model_function.R")

# Run models for each age group and merge them together into one long dataframe
source("./2_Age_65_74.R")
source("./3_Age_75_84.R")
source("./4_Age_85_plus.R")

models <- rbind(
  model_65_74,
  model_75_84,
  model_85_plus
)
```

Results from the models are calculated as the mean difference between strategies compared to baseline. We can also see how many of these simulations are cost-saving (costs < 0), QALY-gaining (QALYs > 0) and cost-effective

```{r}
# Analysis summary
analysis <- models |>
  group_by(Strategy, Prosthesis, Age) |>
  summarise(
    Total_Cost_5y = median(Costs),
    Total_Cost_5y_low = quantile(Costs, 0.025),
    Total_Cost_5y_high = quantile(Costs, 0.975),
    Total_QALY_5y = median(QALYs),
    Total_QALY_5y_low = quantile(QALYs, 0.025),
    Total_QALY_5y_high = quantile(QALYs, 0.975),
    Pct_Cost_Saving = sum(Costs < 0) / iter,
    Pct_QALY_Gaining = sum(QALYs > 0) / iter,
    NMB = sum(median(QALYs) * WTP - median(Costs)),
    Pct_Cost_Effective = sum((QALYs * WTP - Costs) > 0) / iter
  ) |>
  mutate(Total_Cost_5y = Total_Cost_5y * (1 + discount)^5) # Convert $2019 to $2024

confidence <- models |>
  mutate(NMB = QALYs * WTP - Costs,
         iter = rep(1:50000, 12)) |>
  group_by(Strategy, iter) |>
  summarise(Cost_saving = sum(Costs),
            QALY_gaining = sum(QALYs),
            Cost_effective = sum(NMB)) |>
  group_by(Strategy) |>
  summarise(pct_cost_saving = mean(Cost_saving < 0),
            pct_qaly_gaining = mean(QALY_gaining > 0),
            pct_cost_effective = mean(Cost_effective > 0))

total <- analysis |>
  group_by(Strategy) |>
  summarise(
    Cost = sum(Total_Cost_5y),
    Cost_low = sum(Total_Cost_5y_low),
    Cost_high = sum(Total_Cost_5y_high),
    QALY = sum(Total_QALY_5y),
    QALY_low = sum(Total_QALY_5y_low),
    QALY_high = sum(Total_QALY_5y_high),
    PP_Cost = Cost/sum(unlist(prev)),
    PP_Cost_low = Cost_low/sum(unlist(prev)),
    PP_Cost_high = Cost_high/sum(unlist(prev)),
    PP_QALY = sum(Total_QALY_5y)/sum(unlist(prev)),
    PP_QALY_low = sum(Total_QALY_5y_low)/sum(unlist(prev)),
    PP_QALY_high = sum(Total_QALY_5y_high)/sum(unlist(prev))
  )

all_medicare <- cbind(total[,1], total[,c(2:6)] / (sum(unlist(prev))/286861))

write.csv(analysis, "./full_model.csv")
```

The above results demonstrate the cost and utility impacts of moving to a new fixation policy.

``` {r}
# Likely to be a slight increase to surgery costs for initial procedure
cemented_75 <- bind_rows(
  simulator(
    n = (prev$n_75_HA_cemented + prev$n_75_HA_cementless), agegroup = "age_75",
    modelgroup = "HA_cemented"
  ),
  simulator(n = (prev$n_75_THA_cemented + prev$n_75_THA_cementless), agegroup = "age_75", modelgroup = "THA_cemented")
)

cementless_75 <- bind_rows(
  simulator(n = (prev$n_75_HA_cemented + prev$n_75_HA_cementless), agegroup = "age_75", modelgroup = "HA_cementless"),
  simulator(n = (prev$n_75_THA_cemented + prev$n_75_THA_cementless), agegroup = "age_75", modelgroup = "THA_cementless")
)

sens_cem_75 <- cemented_75 |>
  rowwise() |>
  mutate(
    dislocations = sum(
      Dislocation_year1,
      Dislocation_year2,
      Dislocation_year3,
      Dislocation_year4,
      Dislocation_year5
    ),
    revisions = sum(
      Revision_year1,
      Revision_year2,
      Revision_year3,
      Revision_year4,
      Revision_year5
    )
  ) |>
  group_by(Surgery) |>
  summarise(
    dislocations = mean(dislocations),
    revisions = mean(revisions),
    surgery_costs = mean(Cost_surgery)
  ) |>
  mutate(type = "cemented")

sens_cemless_75 <- cementless_75 |>
  rowwise() |>
  mutate(
    dislocations = sum(
      Dislocation_year1,
      Dislocation_year2,
      Dislocation_year3,
      Dislocation_year4,
      Dislocation_year5
    ),
    revisions = sum(
      Revision_year1,
      Revision_year2,
      Revision_year3,
      Revision_year4,
      Revision_year5
    )
  ) |>
  group_by(Surgery) |>
  summarise(
    dislocations = mean(dislocations),
    revisions = mean(revisions),
    surgery_costs = mean(Cost_surgery)
  ) |>
  mutate(type = "cementless")

sens_75 <- bind_rows(sens_cem_75, sens_cemless_75)
remove(sens_cem_75, sens_cemless_75, cemented_75, cementless_75)

surg_costs <- sens_75 |>
  group_by(type) |>
  summarise(cost_surg = sum(surgery_costs))
```

Looking at the CEA plots, it seems fairly clear that the choice to cement is cost-effective. Note - all simulations are relative to the origin (0, 0) and represent changes to costs/QALYs. The WTP line formula is y ~ 100000x, or 100000/QALY as the cost-effectiveness threshold.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
p_all <- models |>
  group_by(Strategy, Prosthesis, Age) |>
  mutate(sim_no = row_number()) |>
  group_by(sim_no, Strategy) |>
  summarise(
    Costs = sum(Costs),
    QALYs = sum(QALYs)
  ) |>
  ggplot()
p_ha <- models |>
  filter(Prosthesis == "Hemiarthroplasty") |>
  ggplot()
p_tha <- models |>
  filter(Prosthesis == "Total hip arthroplasty") |>
  ggplot()

colours <- c("#EF7C00", "#003D7C")

p_all +
  geom_point(aes(x = QALYs, y = Costs, colour = Strategy), alpha = 0.1) +
  annotate("text", x = -2800, y = 15000000, label = "A") +
  annotate("text", x = 2800, y = 15000000, label = "B") +
  annotate("text", x = -2800, y = -15000000, label = "C") +
  annotate("text", x = 2800, y = -15000000, label = "D") +
  geom_abline(intercept = 0, slope = WTP, linetype = "dashed") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  scale_colour_manual(values = colours) +
  scale_x_continuous(
    limits = c(-3000, 3000),
    breaks = seq(-3000, 3000, 1500)
  ) +
  scale_y_continuous(
    labels = scales::unit_format(prefix = "$", unit = "M", scale = 1e-6),
    limits = c(-12000000, 12000000),
    breaks = seq(-12000000, 12000000, 4000000)
  ) +
  labs(
    x = "QALYs",
    y = "Costs ($millions)",
    title = "All procedures"
  ) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  p_ha +
  geom_point(aes(x = QALYs, y = Costs, colour = Strategy), alpha = 0.1) +
  annotate("text", x = -1200, y = 4500000, label = "A") +
  annotate("text", x = 1200, y = 4500000, label = "B") +
  annotate("text", x = -1200, y = -4500000, label = "C") +
  annotate("text", x = 1200, y = -4500000, label = "D") +
  geom_abline(intercept = 0, slope = WTP, linetype = "dashed") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  facet_wrap(vars(Age), ncol = 1) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  scale_colour_manual(values = colours) +
  scale_x_continuous(
    limits = c(-1200, 1200),
    breaks = seq(-1200, 1200, 600)
  ) +
  scale_y_continuous(
    labels = scales::unit_format(prefix = "$", unit = "M", scale = 1e-6),
    limits = c(-5000000, 5000000),
    breaks = seq(-5000000, 5000000, 2500000)
  ) +
  labs(
    x = "QALYs",
    y = "Costs ($millions)",
    title = "Hemiarthroplasty"
  ) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  p_tha +
  geom_point(aes(x = QALYs, y = Costs, colour = Strategy), alpha = 0.1) +
  annotate("text", x = -40, y = 2800000, label = "A") +
  annotate("text", x = 40, y = 2800000, label = "B") +
  annotate("text", x = -40, y = -2800000, label = "C") +
  annotate("text", x = 40, y = -2800000, label = "D") +
  geom_abline(intercept = 0, slope = WTP, linetype = "dashed") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  facet_wrap(vars(Age), ncol = 1) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  scale_colour_manual(values = colours) +
  scale_x_continuous(
    limits = c(-40, 40),
    breaks = seq(-40, 40, 20)
  ) +
  scale_y_continuous(
    labels = scales::unit_format(prefix = "$", unit = "M", scale = 1e-6),
    limits = c(-3000000, 3000000),
    breaks = seq(-3000000, 3000000, 1000000)
  ) +
  labs(
    x = "QALYs",
    y = "Costs ($millions)",
    title = "Total hip arthroplasty"
  ) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

ggsave("./results_graphic.tiff", height = 6, width = 8)
```

One of our primary motivations is to highlight the false economy of saving 7 minutes for a primary procedure. In our all hips are cemented scenario, this is how that might look:

```{r, echo = FALSE, message = FALSE}
set.seed(888)
baseline_65 <- list(
  HA_cemented_65 = simulator(n = prev$n_65_HA_cemented, agegroup = "age_65", modelgroup = "HA_cemented"),
  HA_cementless_65 = simulator(n = prev$n_65_HA_cementless, agegroup = "age_65", modelgroup = "HA_cementless"),
  THA_cemented_65 = simulator(n = prev$n_65_THA_cemented, agegroup = "age_65", modelgroup = "THA_cemented"),
  THA_cementless_65 = simulator(n = prev$n_65_THA_cementless, agegroup = "age_65", modelgroup = "THA_cementless")
)
baseline_65 <- do.call(rbind, baseline_65)

cemented_65 <- list(
  HA = simulator(n = (prev$n_65_HA_cemented + prev$n_65_HA_cementless), agegroup = "age_65", modelgroup = "HA_cemented"),
  THA = simulator(n = (prev$n_65_THA_cemented + prev$n_65_THA_cementless), agegroup = "age_65", modelgroup = "THA_cemented")
)
cemented_65 <- do.call(rbind, cemented_65)

baseline_75 <- list(
  HA_cemented_75 = simulator(n = prev$n_75_HA_cemented, agegroup = "age_75", modelgroup = "HA_cemented"),
  HA_cementless_75 = simulator(n = prev$n_75_HA_cementless, agegroup = "age_75", modelgroup = "HA_cementless"),
  THA_cemented_75 = simulator(n = prev$n_75_THA_cemented, agegroup = "age_75", modelgroup = "THA_cemented"),
  THA_cementless_75 = simulator(n = prev$n_75_THA_cementless, agegroup = "age_75", modelgroup = "THA_cementless")
)
baseline_75 <- do.call(rbind, baseline_75)

cemented_75 <- list(
  HA = simulator(n = (prev$n_75_HA_cemented + prev$n_75_HA_cementless), agegroup = "age_75", modelgroup = "HA_cemented"),
  THA = simulator(n = (prev$n_75_THA_cemented + prev$n_75_THA_cementless), agegroup = "age_75", modelgroup = "THA_cemented")
)
cemented_75 <- do.call(rbind, cemented_75)

baseline_85 <- list(
  HA_cemented_85 = simulator(n = prev$n_85_HA_cemented, agegroup = "age_85", modelgroup = "HA_cemented"),
  HA_cementless_85 = simulator(n = prev$n_85_HA_cementless, agegroup = "age_85", modelgroup = "HA_cementless"),
  THA_cemented_85 = simulator(n = prev$n_85_THA_cemented, agegroup = "age_85", modelgroup = "THA_cemented"),
  THA_cementless_85 = simulator(n = prev$n_85_THA_cementless, agegroup = "age_85", modelgroup = "THA_cementless")
)
baseline_85 <- do.call(rbind, baseline_85)

cemented_85 <- list(
  HA = simulator(n = (prev$n_85_HA_cemented + prev$n_85_HA_cementless), agegroup = "age_85", modelgroup = "HA_cemented"),
  THA = simulator(n = (prev$n_85_THA_cemented + prev$n_85_THA_cementless), agegroup = "age_85", modelgroup = "THA_cemented")
)
cemented_85 <- do.call(rbind, cemented_85)

baseline <- do.call(rbind, list(baseline_65, baseline_75, baseline_85))
cemented <- do.call(rbind, list(cemented_65, cemented_75, cemented_85))
remove(baseline_65, baseline_75, baseline_85, cemented_65, cemented_75, cemented_85)

baseline_revisions <- baseline |>
  rowwise() |>
  mutate(
    Revisions = sum(c(
      Revision_year1,
      Revision_year2,
      Revision_year3,
      Revision_year4,
      Revision_year5
    ))
  ) |>
  select(Surgery, Revisions) %>%
  split(.$Surgery) |>
  map(pull, Revisions) |>
  reduce(`+`)

baseline_dislocations <- baseline |>
  rowwise() |>
  mutate(
    Dislocations = sum(c(
      Dislocation_year1,
      Dislocation_year2,
      Dislocation_year3,
      Dislocation_year4,
      Dislocation_year5
    ))
  ) |>
  select(Surgery, Dislocations) %>%
  split(.$Surgery) |>
  map(pull, Dislocations) |>
  reduce(`+`)

cemented_revisions <- cemented |>
  rowwise() |>
  mutate(
    Revisions = sum(c(
      Revision_year1,
      Revision_year2,
      Revision_year3,
      Revision_year4,
      Revision_year5
    ))
  ) |>
  select(Surgery, Revisions) %>%
  split(.$Surgery) |>
  map(pull, Revisions) |>
  reduce(`+`)

cemented_dislocations <- cemented |>
  rowwise() |>
  mutate(
    Dislocations = sum(c(
      Dislocation_year1,
      Dislocation_year2,
      Dislocation_year3,
      Dislocation_year4,
      Dislocation_year5
    ))
  ) |>
  select(Surgery, Dislocations) %>%
  split(.$Surgery) |>
  map(pull, Dislocations) |>
  reduce(`+`)


change <- tibble(
  Revisions = cemented_revisions - baseline_revisions,
  Dislocations = cemented_dislocations - baseline_dislocations
)


# Cementing time: from Cochrane review doi.org/10.1002/14651858.CD001706.pub4
# 7.24 minutes on average (4.75, 9.73)
set.seed(888)
extra_minutes_OT <- sum(
  prev$n_65_HA_cementless, prev$n_65_THA_cementless,
  prev$n_75_HA_cementless, prev$n_75_THA_cementless,
  prev$n_85_HA_cementless, prev$n_85_THA_cementless
) * rgamma(iter, shape = 30.372, scale = 0.231) / 60

# Change in revisions:
print(paste0(
  "Cementing requires an additional ", ceiling(mean(extra_minutes_OT)), " (",
  ceiling(quantile(extra_minutes_OT, 0.025)), ", ", ceiling(quantile(extra_minutes_OT, 0.975)), ") ",
  " hours per year (nationally) of operating theater time."
))

print(paste0(
  "Revision change over 5 years: ", ceiling(mean(change$Revisions)), " (",
  ceiling(quantile(change$Revisions, 0.975)), ", ",
  ceiling(quantile(change$Revisions, 0.025)), ")"
))


# Dislocation time from https://doi.org/10.1016/j.ajem.2005.03.002
# Time required to do the closed reduction: 10 (1, 41) minutes with a sample of 112
# Assuming SD of 10.72, the SE is 1.013
reduction_time <- rnorm(iter, 10, 1.013) * change$Dislocations / 60

print(paste0(
  "As a result of cementing, there would be an anticipated change of ",
  ceiling(mean(reduction_time)), " (",
  ceiling(quantile(reduction_time, 0.025)), ", ",
  ceiling(quantile(reduction_time, 0.975)), ") ",
  "hours of physician time from avoiding closed reductions."
))

# ED time from same paper (above), patients waited from 1h25m to 13h40m
# Mean of 5.95. Assuming SD of 3.20, SE is 0.297
ED_time <- rnorm(iter, 5.95, 0.297) * change$Dislocations

print(paste0(
  "This would be accompanied by an anticipated change of ",
  ceiling(mean(ED_time)), " (",
  ceiling(quantile(ED_time, 0.025)), ", ",
  ceiling(quantile(ED_time, 0.975)), ") ",
  "hours of ED time from avoiding dislocation-associated visits."
))
```

Revision rate figure to aid interpretation of model parameters. Combine with prevalence data to meet journal table and figure limits.
```{r}
p <- rbind(
  cbind(age = "Age 65 - 74", map_df(transitions$revision$age_65, ~ as.data.frame(.x), .id = "Fixation")),
  cbind(age = "Age 75 - 84", map_df(transitions$revision$age_75, ~ as.data.frame(.x), .id = "Fixation")),
  cbind(age = "Age 85 and over", map_df(transitions$revision$age_85, ~ as.data.frame(.x), .id = "Fixation"))
) |>
  pivot_longer(cols = c(year1, year2, year3, year4, year5), names_to = "year") |>
  mutate(
    Fixation = as.factor(Fixation),
    year = as.factor(year)
  ) |>
  ggplot()

levels(p$data$Fixation) <- c("Cemented HA", "Cementless HA", "Cemented THA", "Cementless THA")
levels(p$data$year) <- c("Year 1", "Year 2", "Year 3", "Year 4", "Year 5")

p +
  geom_histogram(aes(y = value, fill = Fixation), alpha = 0.6, position = "identity", bins = 40) +
  scale_fill_manual(values = c("#440154FF", "#7AD151FF", "#414487FF", "#22A884FF")) +
  facet_wrap(vars(age, year), ncol = 5) +
  scale_y_continuous(limits = c(0, 0.04), breaks = seq(0, 0.04, 0.01)) +
  scale_x_continuous(limits = c(0, 50000), breaks = c(0, 25000, 50000)) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "top"
  ) +
  labs(x = "Number of simulations", y = "Probability of event")

ggsave("revision_rates.jpg", height = 6, width = 9)
```
