---
title: Economic analysis of femoral stem fixation method in a US Medicare population
  with hip fracture
output:
  html_document:
    df_print: paged
---
The goal of this analysis is to replicate the results from Blythe et al (2020): Fixation method for hip stems following femoral neck fracture, but in a US-based Medicare population. The three age groups will be similar to the original study but bounded by Medicare inclusion: 65-74, 75-84, and 85+. Data will be comprised of US-based registry data for transition probabilities (revision, mortality) and costs where possible. Where new data is unobtainable, we will use values from the literature. The analysis is shown below.

```{r, message = FALSE}
options(scipen = 100, digits = 5)
library(EnvStats)
library(LaplacesDemon)
library(patchwork)
library(knitr)
library(tidyverse)

# Model inputs
iter <- 50000 # define number of iterations
discount <- 0.03 # define discount rate
WTP <- 100000 # US WTP threshold
```

The basic structure of this population-based model is as follows:  
1. Obtain the basic prevalence of each group: HA vs THA, cemented vs cementless, and by age, for 12 groups in total. All patients in this model are assumed to be receiving their new hips following a femoral neck fracture.  
2. Assume that each group enters the model at time 0, or when they first receive the prosthesis, and are assigned a cost for the procedure.  
3. Each group then proceeds through a 5 year span, iterating by year, with the costs and utilities of stable states, revisions and dislocations varying by year. The stable population in each year corresponds to the surviving population who has not undergone a revision surgery or closed reduction of dislocation.  
4. The differences between the baseline population and a default strategy of cementing or not cementing for each age group will be calculated by assuming that all patients receive a particular fixation type for femoral stem, rather than using the existing prevalence of each procedure.  

```{r}
# Call parameters and functions required to populate models
set.seed(888) # repeatability
source("./0_Parameters_US.R")
source("./1_Model_function.R")

# Run models for each age group and merge them together into one long dataframe
source("./2_Age_65_74.R")
source("./3_Age_75_84.R")
source("./4_Age_85_plus.R")

models <- rbind(
  model_65_74,
  model_75_84,
  model_85_plus
)

kable(head(models), format.args = list(big.mark = ","), caption = "Extract of simulation model results")
```

Results from the models are calculated as the mean difference between strategies compared to baseline. We can also see how many of these simulations are cost-saving (costs < 0), QALY-gaining (QALYs > 0) and cost-effective ()

```{r}
# Analysis summary
analysis <- models |>
  group_by(Strategy, Prosthesis, Age) |>
  summarise(
    Total_Cost_5y = mean(Costs),
    Total_Cost_5y_low = quantile(Costs, 0.025),
    Total_Cost_5y_high = quantile(Costs, 0.975),
    Total_QALY_5y = mean(QALYs),
    Total_QALY_5y_low = quantile(QALYs, 0.025),
    Total_QALY_5y_high = quantile(QALYs, 0.975),
    Pct_Cost_Saving = sum(Costs < 0) / iter,
    Pct_QALY_Gaining = sum(QALYs > 0) / iter,
    NMB = sum(mean(QALYs) * WTP - mean(Costs)),
    Pct_Cost_Effective = sum((QALYs * WTP - Costs) > 0) / iter
  ) |>
  mutate(Total_Cost_5y = Total_Cost_5y * (1 + discount)^5) # Convert $2019 to $2024

total <- analysis |>
  group_by(Strategy) |>
  summarise(Cost = sum(Total_Cost_5y),
            Cost_low = sum(Total_Cost_5y_low),
            Cost_high = sum(Total_Cost_5y_high),
            QALY = sum(Total_QALY_5y),
            QALY_low = sum(Total_QALY_5y_low),
            QALY_high = sum(Total_QALY_5y_high))

with(subset(total, Strategy == "All patients receive cemented fixation"), 
     print(paste0("The overall annual savings to Medicare of switching to cemented fixation are $",
             ceiling(sum(Cost)), " ($", ceiling(sum(Cost_low)), ", $", ceiling(sum(Cost_high)), ")",
             " and ",
             ceiling(sum(QALY)), " (", ceiling(sum(QALY_low)), ", ", ceiling(sum(QALY_high)), ")",
             " QALYs.")))

kable(analysis, format.args = list(big.mark = ","), caption = "Simulation results")
write.csv(analysis, "./full_model.csv")
```

Looking at the CEA plots, it seems fairly clear that the choice to cement is cost-effective. Note - all simulations are relative to the origin (0, 0) and represent changes to costs/QALYs. The WTP line formula is y ~ 50000x, or 50000/QALY as the cost-effectiveness threshold.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
p_all <- models |>
  group_by(Strategy, Prosthesis, Age) |>
  mutate(sim_no = row_number()) |>
  group_by(sim_no, Strategy) |>
  summarise(Costs = sum(Costs),
            QALYs = sum(QALYs)) |>
  ggplot()
p_ha <- models |>
  filter(Prosthesis == "Hemiarthroplasty") |>
  ggplot()
p_tha <- models |>
  filter(Prosthesis == "Total hip arthroplasty") |>
  ggplot()

colours <- c("#999999", "#8B0000")

p_all +
  geom_point(aes(x = QALYs, y = Costs, colour = Strategy), alpha = 0.1) +
  annotate("text", x = -5800, y = 60000000, label = "A") +
  annotate("text", x = 5800, y = 60000000, label = "B") +
  annotate("text", x = -5800, y = -60000000, label = "C") +
  annotate("text", x = 5800, y = -60000000, label = "D") +
  geom_abline(intercept = 0, slope = WTP, linetype = "dashed") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  scale_colour_manual(values = colours) +
  scale_x_continuous(limits = c(-6000, 6000),
                     breaks = seq(-6000, 6000, 3000)) +
  scale_y_continuous(labels = scales::unit_format(prefix = "$", unit = "M", scale = 1e-6),
                     limits = c(-60000000, 60000000),
                     breaks = seq(-60000000, 60000000, 15000000)) +
  labs(
    x = "QALYs",
    y = "Costs ($millions)",
    title = "All procedures"
  ) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  p_ha +
  geom_point(aes(x = QALYs, y = Costs, colour = Strategy), alpha = 0.1) +
  annotate("text", x = -1800, y = 28000000, label = "A") +
  annotate("text", x = 1800, y = 28000000, label = "B") +
  annotate("text", x = -1800, y = -28000000, label = "C") +
  annotate("text", x = 1800, y = -28000000, label = "D") +
  geom_abline(intercept = 0, slope = WTP, linetype = "dashed") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  facet_wrap(vars(Age), ncol = 1) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  scale_colour_manual(values = colours) +
  scale_x_continuous(limits = c(-2000, 2000),
                     breaks = seq(-2000, 2000, 1000)) +
  scale_y_continuous(labels = scales::unit_format(prefix = "$", unit = "M", scale = 1e-6),
                     limits = c(-30000000, 30000000),
                     breaks = seq(-30000000, 30000000, 15000000)) +
  labs(
    x = "QALYs",
    y = "Costs ($millions)",
    title = "Hemiarthroplasty"
  ) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  p_tha +
  geom_point(aes(x = QALYs, y = Costs, colour = Strategy), alpha = 0.1) +
  annotate("text", x = -140, y = 9000000, label = "A") +
  annotate("text", x = 140, y = 9000000, label = "B") +
  annotate("text", x = -140, y = -9000000, label = "C") +
  annotate("text", x = 140, y = -9000000, label = "D") +
  geom_abline(intercept = 0, slope = WTP, linetype = "dashed") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  facet_wrap(vars(Age), ncol = 1) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  scale_colour_manual(values = colours) +
  scale_x_continuous(limits = c(-150, 150),
                     breaks = seq(-150, 150, 75)) +
  scale_y_continuous(labels = scales::unit_format(prefix = "$", unit = "M", scale = 1e-6),
                     limits = c(-10000000, 10000000),
                     breaks = seq(-10000000, 10000000, 5000000)) +
  labs(
    x = "QALYs",
    y = "Costs ($millions)",
    title = "Total hip arthroplasty"
  ) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  plot_annotation(title = "Cost-effectiveness of setting default stem fixation") +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

ggsave("./results_graphic.png", height = 6, width = 8)
```

Some notes for your abstract:
One of our primary motivations is to highlight the false economy of saving 8 minutes for a primary procedure. In our all hips are cemented scenario, this is how that might look:

```{r, echo = FALSE, message = FALSE}
baseline_65 <- list(
  HA_cemented_65 = simulator(n = prev$n_65_HA_cemented, agegroup = "age_65", modelgroup = "HA_cemented"),
  HA_cementless_65 = simulator(n = prev$n_65_HA_cementless, agegroup = "age_65", modelgroup = "HA_cementless"),
  THA_cemented_65 = simulator(n = prev$n_65_THA_cemented, agegroup = "age_65", modelgroup = "THA_cemented"),
  THA_cementless_65 = simulator(n = prev$n_65_THA_cementless, agegroup = "age_65", modelgroup = "THA_cementless")
)
baseline_65 <- do.call(rbind, baseline_65)

cemented_65 <- list(
  HA = simulator(n = (prev$n_65_HA_cemented + prev$n_65_HA_cementless), agegroup = "age_65", modelgroup = "HA_cemented"),
  THA = simulator(n = (prev$n_65_THA_cemented + prev$n_65_THA_cementless), agegroup = "age_65", modelgroup = "THA_cemented")
)
cemented_65 <- do.call(rbind, cemented_65)

baseline_75 <- list(
  HA_cemented_75 = simulator(n = prev$n_75_HA_cemented, agegroup = "age_75", modelgroup = "HA_cemented"),
  HA_cementless_75 = simulator(n = prev$n_75_HA_cementless, agegroup = "age_75", modelgroup = "HA_cementless"),
  THA_cemented_75 = simulator(n = prev$n_75_THA_cemented, agegroup = "age_75", modelgroup = "THA_cemented"),
  THA_cementless_75 = simulator(n = prev$n_75_THA_cementless, agegroup = "age_75", modelgroup = "THA_cementless")
)
baseline_75 <- do.call(rbind, baseline_75)

cemented_75 <- list(
  HA = simulator(n = (prev$n_75_HA_cemented + prev$n_75_HA_cementless), agegroup = "age_75", modelgroup = "HA_cemented"),
  THA = simulator(n = (prev$n_75_THA_cemented + prev$n_75_THA_cementless), agegroup = "age_75", modelgroup = "THA_cemented")
)
cemented_75 <- do.call(rbind, cemented_75)

baseline_85 <- list(
  HA_cemented_85 = simulator(n = prev$n_85_HA_cemented, agegroup = "age_85", modelgroup = "HA_cemented"),
  HA_cementless_85 = simulator(n = prev$n_85_HA_cementless, agegroup = "age_85", modelgroup = "HA_cementless"),
  THA_cemented_85 = simulator(n = prev$n_85_THA_cemented, agegroup = "age_85", modelgroup = "THA_cemented"),
  THA_cementless_85 = simulator(n = prev$n_85_THA_cementless, agegroup = "age_85", modelgroup = "THA_cementless")
)
baseline_85 <- do.call(rbind, baseline_85)

cemented_85 <- list(
  HA = simulator(n = (prev$n_85_HA_cemented + prev$n_85_HA_cementless), agegroup = "age_85", modelgroup = "HA_cemented"),
  THA = simulator(n = (prev$n_85_THA_cemented + prev$n_85_THA_cementless), agegroup = "age_85", modelgroup = "THA_cemented")
)
cemented_85 <- do.call(rbind, cemented_85)

baseline <- do.call(rbind, list(baseline_65, baseline_75, baseline_85))
cemented <- do.call(rbind, list(cemented_65, cemented_75, cemented_85))

revisions_baseline <- baseline |>
  group_by(Surgery) |>
  summarise(Revisions = sum(mean(Revision_year1),
                            mean(Revision_year2),
                            mean(Revision_year3),
                            mean(Revision_year4),
                            mean(Revision_year5))) |>
  summarise(Total = sum(Revisions)) |>
  pull()

dislocations_baseline <- baseline |>
  group_by(Surgery) |>
  summarise(Dislocations = sum(mean(Dislocation_year1),
                            mean(Dislocation_year2),
                            mean(Dislocation_year3),
                            mean(Dislocation_year4),
                            mean(Dislocation_year5))) |>
  summarise(Total = sum(Dislocations)) |>
  pull()

revisions_cemented <- cemented |>
  group_by(Surgery) |>
  summarise(Revisions = sum(mean(Revision_year1),
                            mean(Revision_year2),
                            mean(Revision_year3),
                            mean(Revision_year4),
                            mean(Revision_year5))) |>
  summarise(Total = sum(Revisions)) |>
  pull()

dislocations_cemented <- cemented |>
  group_by(Surgery) |>
  summarise(Dislocations = sum(mean(Dislocation_year1),
                            mean(Dislocation_year2),
                            mean(Dislocation_year3),
                            mean(Dislocation_year4),
                            mean(Dislocation_year5))) |>
  summarise(Total = sum(Dislocations)) |>
  pull()

extra_minutes <- sum(prev$n_65_HA_cementless, prev$n_65_THA_cementless,
                     prev$n_75_HA_cementless, prev$n_75_THA_cementless,
                     prev$n_85_HA_cementless, prev$n_85_THA_cementless) * mean(rgamma(iter, shape = 32.478, scale = 0.223))/60

print(paste0("Cementing requires an additional ", ceiling(extra_minutes), " hours per year (nationally) of operating theater time."))
print("This is the time cost to surgeons of applying cement. The tradeoff is that this leads to less revisions and dislocations:")
print(paste0(ceiling(revisions_baseline - revisions_cemented), " revisions avoided over 5 years. "))
print(paste0(ceiling(dislocations_baseline - dislocations_cemented), " dislocations avoided over 5 years."))

```






